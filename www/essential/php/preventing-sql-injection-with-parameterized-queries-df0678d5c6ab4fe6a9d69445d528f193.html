<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="referrer" content="always">

  <meta name="twitter:card" value="summary">
  <meta name="twitter:site" content="@kjk">
  <meta name="twitter:title" content="Preventing SQL injection with Parameterized Queries">
  
  <meta name="twitter:description" content="Preventing SQL injection with Parameterized Queries">
  <meta name="twitter:creator" content="@kjk">
  <meta name="twitter:image" content="/essential/php/covers/twitter/PHP.png">
  
  <meta property="og:title" content="Preventing SQL injection with Parameterized Queries">
  <meta property="og:type" content="article" />
  <meta property="og:url" content="/essential/php/preventing-sql-injection-with-parameterized-queries-df0678d5c6ab4fe6a9d69445d528f193" />
  
  <meta property="og:description" content="Preventing SQL injection with Parameterized Queries">
  <meta property="og:image" content="/essential/php/covers/twitter/PHP.png">

  <title>PDO / Preventing SQL injection with Parameterized Queries / Essential PHP</title>
  <meta name="description" content="PDO / Preventing SQL injection with Parameterized Queries / Essential PHP">

  <link rel="icon" href="s/favicon-9dfe2f70.ico">

  <link href="s/main-e8ec5816.css" rel="stylesheet">
  <link href="s/bundle-83cf4538.css" rel="stylesheet">

  
  <script src="s/app-php-3942f5e2.js" defer></script>
  <script src="s/bundle-fd6a7ad6.js" defer></script>
</head>

<body class="page">
  <script>
  function onLoad() {
    gBookTitle = "Essential PHP";

    httpsMaybeRedirect();

    let opts = {
      target: document.getElementById("toc"),
      props: {
        parentIdx: -1,
        level: 0,
      },
    };
    new app.toc(opts);

    opts = {
      target: document.getElementById("search-parent"),
      props: {
        bookTitle: gBookTitle,
      },
    };
    new app.searchInput(opts);

    opts = {
      target: document.getElementById("page-toc"),
    };
    new app.pageToc(opts);

    opts = {
      target: document.getElementById("book-toc"),
    };
    new app.bookToc(opts);
  }
  document.addEventListener('DOMContentLoaded', onLoad);
</script>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none">
  <symbol id="arrow-expanded" viewbox="0 0 16 16">
    <path fill="%23646465" d="M11 10H5.344L11 4.414V10z" />
  </symbol>

  <symbol id="arrow-not-expanded" viewbox="0 0 16 16">
    <path fill="%23646465" d="M6 4v8l4-4-4-4zm1 2.414L8.586 8 7 9.586V6.414z" />
  </symbol>

  <symbol id="icon-github" viewbox="0 0 496 512">
    <path
      d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" />
  </symbol>

  <symbol id="icon-home" viewbox="0 0 576 512">
    <path
      d="M488 312.7V456c0 13.3-10.7 24-24 24H348c-6.6 0-12-5.4-12-12V356c0-6.6-5.4-12-12-12h-72c-6.6 0-12 5.4-12 12v112c0 6.6-5.4 12-12 12H112c-13.3 0-24-10.7-24-24V312.7c0-3.6 1.6-7 4.4-9.3l188-154.8c4.4-3.6 10.8-3.6 15.3 0l188 154.8c2.7 2.3 4.3 5.7 4.3 9.3zm83.6-60.9L488 182.9V44.4c0-6.6-5.4-12-12-12h-56c-6.6 0-12 5.4-12 12V117l-89.5-73.7c-17.7-14.6-43.3-14.6-61 0L4.4 251.8c-5.1 4.2-5.8 11.8-1.6 16.9l25.5 31c4.2 5.1 11.8 5.8 16.9 1.6l235.2-193.7c4.4-3.6 10.8-3.6 15.3 0l235.2 193.7c5.1 4.2 12.7 3.5 16.9-1.6l25.5-31c4.2-5.2 3.4-12.7-1.7-16.9z" />
  </symbol>

  <symbol id="icon-twitter" viewbox="0 0 512 512">
    <path
      d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z" />
  </symbol>

  <symbol id="icon-edit" viewbox="0 0 576 512">
    <path
      d="M402.6 83.2l90.2 90.2c3.8 3.8 3.8 10 0 13.8L274.4 405.6l-92.8 10.3c-12.4 1.4-22.9-9.1-21.5-21.5l10.3-92.8L388.8 83.2c3.8-3.8 10-3.8 13.8 0zm162-22.9l-48.8-48.8c-15.2-15.2-39.9-15.2-55.2 0l-35.4 35.4c-3.8 3.8-3.8 10 0 13.8l90.2 90.2c3.8 3.8 10 3.8 13.8 0l35.4-35.4c15.2-15.3 15.2-40 0-55.2zM384 346.2V448H64V128h229.8c3.2 0 6.2-1.3 8.5-3.5l40-40c7.6-7.6 2.2-20.5-8.5-20.5H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V306.2c0-10.7-12.9-16-20.5-8.5l-40 40c-2.2 2.3-3.5 5.3-3.5 8.5z" />
  </symbol>

  <symbol id="icon-star" viewbox="0 0 576 512">
    <path
      d="M528.1 171.5L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6zM388.6 312.3l23.7 138.4L288 385.4l-124.3 65.3 23.7-138.4-100.6-98 139-20.2 62.2-126 62.2 126 139 20.2-100.6 98z" />
  </symbol>
</svg>
  <header class="page__header">
  <div class="page__header__left">
    <a id="link-home" href="index.html">
      <svg class="icon-home">
        <use xlink:href="#icon-home"></use>
      </svg>
      &nbsp;Essential PHP</a>
  </div>
  <div class="page__header__center" id="search-parent">
  </div>
  <div class="page__header__right">
  </div>
</header>

  <div id="toc"></div>

  <div class="content">
    <div class="article">
      

<div style="display: flex; justify-content: space-between">
  <h1 class="title">Preventing SQL injection with Parameterized Queries</h1>
  <a class="edit-link" style="font-size: 80%" href="https://notion.so/df0678d5c6ab4fe6a9d69445d528f193" rel="nofollow"
  target="_blank">suggest change</a>
</div>


      <p>SQL injection is a kind of attack that allows a malicious user to modify the SQL query, adding unwanted commands to it. For example, the following code is <strong>vulnerable</strong>:</p>
<div class="code-box lang-Plain Text">
	<div>
	<pre class="chroma">// Do not use this vulnerable code!
$sql = &#39;SELECT name, email, user_level FROM users WHERE userID = &#39; . $_GET[&#39;user&#39;];
$conn-&gt;query($sql);</pre>
	</div>
	<div class="code-box-nav">
		
	</div>
</div><p>This allows any user of this script to modify our database basically at will. For example consider the following query string:</p>
<div class="code-box lang-Plain Text">
	<div>
	<pre class="chroma">page.php?user=0;%20TRUNCATE%20TABLE%20users;</pre>
	</div>
	<div class="code-box-nav">
		
	</div>
</div><p>This makes our example query look like this</p>
<div class="code-box lang-Plain Text">
	<div>
	<pre class="chroma">SELECT name, email, user_level FROM users WHERE userID = 0; TRUNCATE TABLE users;</pre>
	</div>
	<div class="code-box-nav">
		
	</div>
</div><p>While this is an extreme example (most SQL injection attacks do not aim to delete data, nor do most PHP query execution functions support multi-query), this is an example of how a SQL injection attack can be made possible by the careless assembly of the query. Unfortunately, attacks like this are very common, and are highly effective due to coders who fail to take proper precautions to protect their data.</p><p>To prevent SQL injection from occurring, <strong>prepared statements</strong> are the recommended solution. Instead of concatenating user data directly to the query, a <em>placeholder</em> is used instead. The data is then sent separately, which means there is no chance of the SQL engine confusing user data for a set of instructions.</p><blockquote id="c6e2f98f-e7b2-4b17-bd8e-4a6e9a2739a8" class="">While the topic here is PDO, please note that the PHP MySQLi extension also supports prepared statements</blockquote><p>PDO supports two kinds of placeholders (placeholders cannot be used for column or table names, only values):</p><ol id="c28d0705-639a-4b87-a076-4390bca97228" class="numbered-list" start="1"><li>Named placeholders. A colon(<code>:</code>), followed by a distinct name (eg. <code>:user</code>)</li></ol>
<div class="code-box lang-Plain Text">
	<div>
	<pre class="chroma">// using named placeholders
$sql = &#39;SELECT name, email, user_level FROM users WHERE userID = :user&#39;;
$prep = $conn-&gt;prepare($sql);
$prep-&gt;execute([&#39;user&#39; =&gt; $_GET[&#39;user&#39;]]); // associative array
$result = $prep-&gt;fetchAll();</pre>
	</div>
	<div class="code-box-nav">
		
	</div>
</div><ol id="de480e02-fb3a-4aca-ab4b-b5ab396f0b41" class="numbered-list" start="1"><li>Traditional SQL positional placeholders, represented as <code>?</code>:</li></ol>
<div class="code-box lang-Plain Text">
	<div>
	<pre class="chroma">// using question-mark placeholders
$sql = &#39;SELECT name, user_level FROM users WHERE userID = ? AND user_level = ?&#39;;
$prep = $conn-&gt;prepare($sql);
$prep-&gt;execute([$_GET[&#39;user&#39;], $_GET[&#39;user_level&#39;]]); // indexed array
$result = $prep-&gt;fetchAll();</pre>
	</div>
	<div class="code-box-nav">
		
	</div>
</div><p>If ever you need to dynamically change table or column names, know that this is at your own security risks and a bad practice. Though, it can be done by string concatenation. One way to improve security of such queries is to set a table of allowed values and compare the value you want to concatenate to this table.</p><p>Be aware that it is important to set connection charset through DSN only, otherwise your application could be prone to an <a href="https://stackoverflow.com/questions/134099/are-pdo-prepared-statements-sufficient-to-prevent-sql-injection/12202218#12202218">obscure vulnerability</a> if some odd encoding is used. For PDO versions prior to 5.3.6 setting charset through DSN is not available and thus the only option is to set <code>PDO::ATTR_EMULATE_PREPARES</code> attribute to <code>false</code> on the connection right after it’s created.</p>
<div class="code-box lang-Plain Text">
	<div>
	<pre class="chroma">$conn-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</pre>
	</div>
	<div class="code-box-nav">
		
	</div>
</div><p>This causes PDO to use the underlying DBMS’s native prepared statements instead of just emulating it.</p><p>However, be aware that PDO will <a href="https://github.com/php/php-src/blob/master/ext/pdo_mysql/mysql_driver.c#L210">silently fallback</a> to emulating statements that MySQL cannot prepare natively: those that it can are <a href="http://dev.mysql.com/doc/en/sql-syntax-prepared-statements.html">listed in the manual</a> (<a href="https://stackoverflow.com/questions/134099/are-pdo-prepared-statements-sufficient-to-prevent-sql-injection/12202218#12202218">source</a>).</p>

      <div class="forum-link">
  Found a mistake? Have a question or improvement idea?
  <a href="#" onclick="showContact(); return false;">Let me know</a>.
</div>

      <form id="contact-form" action="https://formsubmit.co/kkowalczyk@gmail.com" method="POST">
  <p>
    <div class="contact-light">Feedback about page:</div>
    <input type="text" name="page-url" id="contact-page-url" readonly />
  </p>

  <p>
    <div class="contact-light">Feedback:</div>
    <textarea name="message" id="msg-for-chris"></textarea>
    <div class="contact-light">Optional: your email if you want me to get back to you: </div>
    <input type="email" name="email" />
    <input type="text" name="_honey" style="display:none">
  </p>

  <p>
    <button type="submit" class="contact-btn">
      Send Feedback
    </button>

    <button class="contact-btn" style="float: right;" onclick="hideContact(); return false;">
      Cancel
    </button>
  </p>

  <p>
    <div data-netlify-recaptcha></div>
  </p>
</form>


      <hr class="article-bottom-sep">
    </div>

    <div id="page-toc"></div>

    <div id="chapter-toc-wrapper">
      <hr />
      <div class="hdr">Table Of Contents</div>
      <div id="book-toc"></div>
    </div>
  </div>

  <footer class="page__footer">
  <div class="page__footer__left">
    Maintained by
    <a href="https://blog.kowalczyk.info" target="_blank">Krzysztof Kowalczyk</a>
  </div>
  <div class="share-me">
    <a href="https://twitter.com/intent/tweet?text=%22Essential%20PHP%22%20-%20a%20free%20programming%20book&url=%2fessential%2fphp%2f&via=kjk">Share
      <b>Essential PHP</b> on&nbsp;
      <svg class="icon-twitter">
        <use xlink:href="#icon-twitter"></use>
      </svg>
    </a>
  </div>
  <div class="page__footer__right">
    
  </div>
</footer>

  

</body>

</html>